<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>Spotilyrics</title>
</head>
<body class="lyricsBody">
<div class="box">
<!--    <div class="line" data-lyrics-id="0">Lorem ipsum dolor sit amet</div>-->
    <div class="placeholder">Looks like we don’t have lyrics yet.</div>
</div>
<script>
    window.addEventListener('message', event => {
        const message = event.data;
        if (message.command === 'addLyrics') {
            const box = document.querySelector('.box');
            const placeholder = box.querySelector('.placeholder');
            const lines = box.querySelectorAll('.line');
            const lyricsNote = box.querySelector('.lyrics-note');
            if (placeholder) {
                placeholder.remove();
            }
            if (lyricsNote) {
                lyricsNote.remove();
            }
            if (lines.length > 0) {
                for (const line of lines) {
                    line.remove();
                }
            }
            const allStrings = message.lyrics.every(item => typeof item === 'string');
            if (allStrings) {
                const lyricsNote = document.createElement('div');
                lyricsNote.className = 'lyrics-note';
                lyricsNote.textContent = 'These lyrics aren\'t synced to the song yet.';
                box.appendChild(lyricsNote);
                for (const line of message.lyrics) {
                    const div = document.createElement('div');
                    div.className = 'line';
                    div.style.opacity = '1';
                    div.textContent = line;
                    box.appendChild(div);
                }
            } else {
                for (const line of message.lyrics) {
                    const div = document.createElement('div');
                    div.className = 'line';
                    div.textContent = String(line.text);
                    if (div.textContent === '') {
                        div.textContent = '♪';
                    }
                    div.dataset.lyricsId = line.id;
                    box.appendChild(div);
                }
            }
            window.scrollTo(0, 0);
            pickLyrics(message.pick);
        } else if (message.command === 'clearLyrics') {
            const box = document.querySelector('.box');
            const placeholder = box.querySelector('.placeholder');
            const lines = box.querySelectorAll('.line');
            const lyricsNote = box.querySelector('.lyrics-note');
            if (lyricsNote) {
                lyricsNote.remove();
            }
            if (lines.length > 0) {
                for (const line of lines) {
                    line.remove();
                }
            }
            if (!placeholder) {
                const div = document.createElement('div');
                div.className = 'placeholder';
                div.textContent = "Looks like we don’t have lyrics yet.";
                box.appendChild(div);
            }
        } else if (message.command === 'pickLyrics') {
            pickLyrics(message.pick);
        }
    });



    function pickLyrics(id) {
        const box = document.querySelector('.box');
        if (!box) {
            return;
        }

        const lines = Array.from(box.querySelectorAll('.line'));
        if (lines.length === 0) {
            return;
        }

        const pickedIndex = lines.findIndex(line => line.dataset.lyricsId === String(id));
        if (pickedIndex === -1) {
            return;
        }

        for (const [index, line] of lines.entries()) {
            if (index < pickedIndex) {
                line.style.opacity = '0.35';
            } else if (index === pickedIndex) {
                line.style.opacity = '1';
            } else {
                line.style.opacity = '0.7';
            }
        }

        const activeLine = lines[pickedIndex];
        activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
</script>
</body>
</html>
